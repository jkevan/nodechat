<html>
<head>
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.js"></script>
	<link rel="icon" type="image/png" href="img/logo.jpg"> 
	<script>
		var socket = io.connect('http://localhost');
		var room;
		var nick;
		
		function addbutton(name) {
			var element = document.createElement("input");
			element.setAttribute("type", "button");
			element.setAttribute("value", name);
			element.setAttribute("name", "sw_chan");
			element.setAttribute("id", name);
			element.setAttribute("onclick", 'managech(\'' + name + '\')');
			var lbtn = document.getElementById("li_button");
			lbtn.appendChild(element);
		}
		
		function managech(channel) {
			$("#console").text('');
			$("#channel").text(channel);
			room = channel;
			socket.emit('switch_channel', $('#'+ channel).val());
		}
		
        socket.on('update_console', function(nickname, msg, checkroom){
			if(checkroom == room)
			{
				$("#console").append('<b>'+ nickname + ':</b> ' + msg + '<br>');
			}
        });

        socket.on('update_users', function(data, checkroom){
			if(checkroom == room)
			{
				$('#users').empty();
				$.each(data, function(key, value) {
					if(value)
					{
						$('#users').append('<div>' + value + '</div>');
					}
				});
			}
        });
		
		socket.on('manage_channel', function(action, channel){
			if(action == 'add')
			{
				addbutton(channel);
				$("#console").text('');
				$("#channel").text(channel);
				room = channel;
			}
			if(action == 'del')
			{
				var parent = document.getElementById('li_button');
				parent.removeChild(document.getElementById(channel));
			}
        });

        $(function(){
            $('#connect').click(function(){
                var nickname = $('#desired_nickname').val();
                var channel = $('#desired_channel').val();
                if(nickname && channel){
                    room = channel;
                    nick = nickname;
                    socket.emit("add_user", nickname, channel);

                    $("#form_connect").hide();
                    $("#form_send").show();
                    $("#channel").text(channel);
                    $("#nickname").text(nickname);
                }
            });

            $('#send').click( function() {
                var msg = $('#msg').val();
                $('#msg').val('');
                socket.emit('send_msg', msg, room);
            });

            $('#msg').keypress(function(e) {
                if(e.which == 13) {
                    $(this).blur();
                    $('#send').focus().click();
                }
            });
        });
	</script>
</head>
<body>
<div id="form_connect">
    <label for="desired_nickname">pseudo: </label><input type="text" id="desired_nickname">
    <label for="desired_channel">room: </label><input type="text" id="desired_channel">
    <input type="button" id="connect" value="connect">
</div>
<div id="li_button"></div>
<div id="form_send" style="display: none">
	<p id="console">

	</p>
    <div id="users">

    </div>
	<p>Room :<span id="channel"></span></p>
	<p>Nickname :<span id="nickname"></span></p>
    <label for="msg">Message: </label><textarea rows="4" cols="50" id="msg" placeholder="Ecrivez votre message ... Action: /join room  pour rejoindre une autre room ou /quit room  pour quitter la room"></textarea>
    <input type="button" value="send" id="send">
</div>
</body>
</html>